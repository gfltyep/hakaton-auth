<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–º–Ω—ã–µ –ó–∞–º–µ—Ç–∫–∏ - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</title>
    <!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
        }
        .container {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        .user-info, .auth-section {
            margin-bottom: 20px;
        }
        .user-info p {
            font-size: 16px;
            word-wrap: break-word;
        }
        .user-info strong {
            color: #007bff;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 15px;
            font-weight: bold;
        }
        .status.success {
            color: #28a745;
        }
        .status.error {
            color: #dc3545;
        }
        .info-note {
            font-size: 14px;
            color: #666;
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .ios-note {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            margin: 15px 0;
            text-align: left;
            font-size: 14px;
            border-radius: 8px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>–ü–∞–Ω–µ–ª—å –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h1>

    <!-- –†–∞–∑–¥–µ–ª 1: –£–º–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ (–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ ID Telegram) -->
    <div class="user-info" id="telegram-info">
        <h2>–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram</h2>
        <p id="user-data">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</p>
    </div>

    <!-- iOS —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div id="ios-info" class="ios-note" style="display: none;">
        <strong>üì± –î–ª—è iOS:</strong> –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Face ID / Touch ID –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö iPhone.
        –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∏–æ–º–µ—Ç—Ä–∏–∏.
    </div>

    <!-- –†–∞–∑–¥–µ–ª 2: –ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (WebAuthn) -->
    <div class="auth-section">
        <h2>–ë–∏–æ–º–µ—Ç—Ä–∏—è (Face/Touch ID)</h2>
        <button id="register-btn" disabled>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –±–∏–æ–º–µ—Ç—Ä–∏—é</button>
        <button id="login-btn" disabled>–í–æ–π—Ç–∏ –ø–æ –±–∏–æ–º–µ—Ç—Ä–∏–∏</button>
        <p id="webauthn-status" class="status"></p>
    </div>
    
    <div class="info-note" id="browser-info"></div>
</div>

<script>
    // =================================================================
    // –û–ë–©–ê–Ø –õ–û–ì–ò–ö–ê –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // =================================================================
    const tg = window.Telegram.WebApp;
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const userDataEl = document.getElementById('user-data');
    const registerBtn = document.getElementById('register-btn');
    const loginBtn = document.getElementById('login-btn');
    const webauthnStatusEl = document.getElementById('webauthn-status');
    const browserInfoEl = document.getElementById('browser-info');
    const iosInfoEl = document.getElementById('ios-info');
    
    let telegramUser = null;
    let isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    let isInTelegram = tg.initDataUnsafe ? true : false;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º iOS –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (isIOS) {
        iosInfoEl.style.display = 'block';
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Telegram
    tg.ready();
    tg.expand();

    // =================================================================
    // –†–ê–ó–î–ï–õ 1: –ê–í–¢–û–í–•–û–î –ß–ï–†–ï–ó TELEGRAM
    // =================================================================
    
    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
        telegramUser = tg.initDataUnsafe.user;
        userDataEl.innerHTML = `
            –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <strong>${telegramUser.first_name || ''} ${telegramUser.last_name || ''}</strong>!
            <br>–í–∞—à ID: <strong>${telegramUser.id}</strong>
            <br><small>(–≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</small>
        `;
        
        registerBtn.disabled = false;
        loginBtn.disabled = false;

    } else {
        userDataEl.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –≤–∞—à–µ–≥–æ Telegram-–±–æ—Ç–∞.';
        webauthnStatusEl.textContent = '–ë–∏–æ–º–µ—Ç—Ä–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –±–µ–∑ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.';
        webauthnStatusEl.className = 'status error';
    }

    // =================================================================
    // –†–ê–ó–î–ï–õ 2: –ë–ò–û–ú–ï–¢–†–ò–ß–ï–°–ö–ê–Ø –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø (WebAuthn)
    // =================================================================

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É WebAuthn —Å —É—á–µ—Ç–æ–º iOS –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π
    async function checkWebAuthnSupport() {
        let supportInfo = [];
        
        if (!window.PublicKeyCredential) {
            browserInfoEl.textContent = '‚ùå WebAuthn –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.';
            return false;
        }
        
        supportInfo.push('‚úÖ WebAuthn API –¥–æ—Å—Ç—É–ø–µ–Ω');
        
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å platform authenticator
            const isAvailable = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
            if (isAvailable) {
                supportInfo.push('‚úÖ Platform authenticator –¥–æ—Å—Ç—É–ø–µ–Ω');
                browserInfoEl.innerHTML = supportInfo.join('<br>');
                return true;
            } else {
                supportInfo.push('‚ö†Ô∏è Platform authenticator –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
                
                // –î–ª—è iOS –¥–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                if (isIOS) {
                    supportInfo.push('üì± –ù–∞ iOS —ç—Ç–æ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–∂–µ –ø—Ä–∏ —ç—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏');
                    browserInfoEl.innerHTML = supportInfo.join('<br>');
                    return true; // –ü—Ä–æ–±—É–µ–º –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–∞ iOS
                }
                
                browserInfoEl.innerHTML = supportInfo.join('<br>');
                return false;
            }
        } catch (error) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebAuthn:', error);
            
            if (isIOS) {
                // –ù–∞ iOS —ç—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–∞—Å—Ç–æ –ø–∞–¥–∞–µ—Ç, –Ω–æ WebAuthn –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
                supportInfo.push('üì± –ù–∞ iOS –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏');
                browserInfoEl.innerHTML = supportInfo.join('<br>');
                return true;
            }
            
            browserInfoEl.innerHTML = '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –±–∏–æ–º–µ—Ç—Ä–∏–∏.';
            return true;
        }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function bufferToBase64(buff) {
        return btoa(String.fromCharCode.apply(null, new Uint8Array(buff)));
    }

    function base64ToBuffer(base64) {
        const str = atob(base64);
        const buffer = new Uint8Array(str.length);
        for (let i = 0; i < str.length; i++) {
            buffer[i] = str.charCodeAt(i);
        }
        return buffer;
    }

    function strToArrayBuffer(str) {
        const encoder = new TextEncoder();
        return encoder.encode(str);
    }

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π RP ID
    function getRpId() {
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            return 'localhost';
        }
        return window.location.hostname;
    }

    // --- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ë–ò–û–ú–ï–¢–†–ò–ò ---
    registerBtn.addEventListener('click', async () => {
        if (!telegramUser) return;
        
        webauthnStatusEl.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏...';
        webauthnStatusEl.className = 'status';

        // –î–ª—è iOS –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        if (isIOS) {
            webauthnStatusEl.textContent = 'üì± iOS: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Face ID...';
        }

        try {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º challenge
            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);
            
            // –°–æ–∑–¥–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è iOS –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º)
            const userIdBuffer = new Uint8Array(32);
            const encoder = new TextEncoder();
            const idString = String(telegramUser.id);
            const idBytes = encoder.encode(idString);
            
            // –ö–æ–ø–∏—Ä—É–µ–º –±–∞–π—Ç—ã, –Ω–æ –Ω–µ –±–æ–ª—å—à–µ —Ä–∞–∑–º–µ—Ä–∞ –±—É—Ñ–µ—Ä–∞
            for (let i = 0; i < Math.min(idBytes.length, 32); i++) {
                userIdBuffer[i] = idBytes[i];
            }
            
            // –ë–∞–∑–æ–≤—ã–µ –æ–ø—Ü–∏–∏ –¥–ª—è WebAuthn
            const createOptions = {
                publicKey: {
                    challenge: challenge,
                    rp: {
                        name: "–£–º–Ω—ã–µ –ó–∞–º–µ—Ç–∫–∏",
                        id: getRpId()
                    },
                    user: {
                        id: userIdBuffer,
                        name: telegramUser.username || String(telegramUser.id),
                        displayName: `${telegramUser.first_name || ''} ${telegramUser.last_name || ''}`.trim() || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                    },
                    pubKeyCredParams: [
                        { alg: -7, type: "public-key" }, // ES256
                        { alg: -257, type: "public-key" } // RS256
                    ],
                    authenticatorSelection: {
                        authenticatorAttachment: "platform",
                        residentKey: "preferred",
                        userVerification: "required",
                    },
                    timeout: 60000,
                    attestation: "none",
                }
            };

            // –î–ª—è iOS –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –º—è–≥–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            if (isIOS) {
                createOptions.publicKey.authenticatorSelection.userVerification = "preferred";
                // –£–±–∏—Ä–∞–µ–º authenticatorAttachment –Ω–∞ iOS
                delete createOptions.publicKey.authenticatorSelection.authenticatorAttachment;
            }

            console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', createOptions);
            webauthnStatusEl.textContent = 'üîê –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Face ID / Touch ID –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...';
            
            // –í–∞–∂–Ω–æ: –Ω–∞ iOS –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å credential.create –≤ –æ—Ç–≤–µ—Ç –Ω–∞ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const credential = await navigator.credentials.create(createOptions);
            
            console.log('–ö–ª—é—á —Å–æ–∑–¥–∞–Ω:', credential);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const credentialForServer = {
                id: credential.id,
                rawId: bufferToBase64(credential.rawId),
                type: credential.type,
                response: {
                    clientDataJSON: bufferToBase64(credential.response.clientDataJSON),
                    attestationObject: bufferToBase64(credential.response.attestationObject),
                },
            };
            
            localStorage.setItem(`webauthn_cred_${telegramUser.id}`, JSON.stringify(credentialForServer));

            webauthnStatusEl.textContent = '‚úÖ –ë–∏–æ–º–µ—Ç—Ä–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞!';
            webauthnStatusEl.className = 'status success';

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ WebAuthn:', err);
            
            let errorMessage = '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
            
            if (err.name === 'NotAllowedError') {
                if (isIOS) {
                    errorMessage = '–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Face ID/Touch ID –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö iPhone.';
                } else {
                    errorMessage = '–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ –∏–ª–∏ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.';
                }
            } else if (err.name === 'NotSupportedError') {
                errorMessage = '–ë–∏–æ–º–µ—Ç—Ä–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.';
            } else if (err.name === 'SecurityError') {
                errorMessage = '–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∞–π—Ç –æ—Ç–∫—Ä—ã—Ç –ø–æ HTTPS.';
            } else if (err.message) {
                errorMessage = err.message;
            }
            
            webauthnStatusEl.textContent = `‚ùå ${errorMessage}`;
            webauthnStatusEl.className = 'status error';
        }
    });

    // --- –í–•–û–î –ü–û –ë–ò–û–ú–ï–¢–†–ò–ò ---
    loginBtn.addEventListener('click', async () => {
        if (!telegramUser) return;

        webauthnStatusEl.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –≤—Ö–æ–¥—É...';
        webauthnStatusEl.className = 'status';

        try {
            const storedCredString = localStorage.getItem(`webauthn_cred_${telegramUser.id}`);
            
            let getOptions = {
                publicKey: {
                    timeout: 60000,
                    userVerification: "required",
                    rpId: getRpId(),
                }
            };

            // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
            if (storedCredString) {
                const storedCred = JSON.parse(storedCredString);
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º challenge
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);
                
                getOptions.publicKey.challenge = challenge;
                getOptions.publicKey.allowCredentials = [{
                    type: "public-key",
                    id: base64ToBuffer(storedCred.rawId),
                }];
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ–±—É–µ–º –±–µ–∑ allowCredentials
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);
                getOptions.publicKey.challenge = challenge;
            }

            // –î–ª—è iOS –º–µ–Ω—è–µ–º verification
            if (isIOS) {
                getOptions.publicKey.userVerification = "preferred";
            }

            console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—Ö–æ–¥–∞:', getOptions);
            webauthnStatusEl.textContent = 'üîê –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Face ID / Touch ID –¥–ª—è –≤—Ö–æ–¥–∞...';
            
            const assertion = await navigator.credentials.get(getOptions);
            console.log('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ:', assertion);

            webauthnStatusEl.textContent = '‚úÖ –í—Ö–æ–¥ –ø–æ –±–∏–æ–º–µ—Ç—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!';
            webauthnStatusEl.className = 'status success';

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –ø–æ WebAuthn:', err);
            
            let errorMessage = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
            
            if (err.name === 'NotAllowedError') {
                if (isIOS) {
                    errorMessage = '–í—Ö–æ–¥ –æ—Ç–º–µ–Ω–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Face ID.';
                } else {
                    errorMessage = '–í—Ö–æ–¥ –æ—Ç–º–µ–Ω–µ–Ω –∏–ª–∏ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω.';
                }
            } else if (err.name === 'NotFoundError') {
                errorMessage = '–ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å —Å–Ω–∞—á–∞–ª–∞.';
            } else if (err.message) {
                errorMessage = err.message;
            }
            
            webauthnStatusEl.textContent = `‚ùå ${errorMessage}`;
            webauthnStatusEl.className = 'status error';
        }
    });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    checkWebAuthnSupport().then(supported => {
        if (!supported && !isIOS) {
            registerBtn.disabled = true;
            loginBtn.disabled = true;
        }
    });

    // –î–ª—è iOS –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–∞—Å–∞–Ω–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –±–∏–æ–º–µ—Ç—Ä–∏–∏
    if (isIOS) {
        document.addEventListener('touchstart', function() {
            // –ù–µ–±–æ–ª—å—à–∞—è —Ö–∏—Ç—Ä–æ—Å—Ç—å –¥–ª—è iOS - "–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º" –∫–æ–Ω—Ç–µ–∫—Å—Ç
            console.log('Touch detected on iOS');
        }, { once: true });
    }

</script>

</body>
</html>
