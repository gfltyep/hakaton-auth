<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–º–Ω—ã–µ –ó–∞–º–µ—Ç–∫–∏ - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
        }
        .container {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        h2 {
            font-size: 18px;
            margin-bottom: 15px;
        }
        .user-info, .auth-section {
            margin-bottom: 20px;
        }
        .user-info p {
            font-size: 16px;
            word-wrap: break-word;
        }
        .user-info strong {
            color: #007bff;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
            -webkit-appearance: none;
            appearance: none;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        button.secondary {
            background-color: #34c759;
        }
        button.secondary:hover {
            background-color: #2db84d;
        }
        .status {
            margin-top: 15px;
            font-weight: bold;
            padding: 10px;
            border-radius: 8px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .info-note {
            font-size: 14px;
            color: #666;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
            text-align: left;
        }
        .ios-note {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
            font-size: 14px;
            border-radius: 10px;
        }
        .pin-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        .pin-input {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            text-align: center;
            letter-spacing: 8px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin: 10px 0;
            box-sizing: border-box;
        }
        .pin-input:focus {
            border-color: #007bff;
            outline: none;
        }
        .biometric-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üîê –£–º–Ω—ã–µ –ó–∞–º–µ—Ç–∫–∏</h1>

    <!-- –†–∞–∑–¥–µ–ª 1: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
    <div class="user-info" id="telegram-info">
        <h2>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h2>
        <p id="user-data">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</p>
    </div>

    <!-- iOS —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div id="ios-info" class="ios-note" style="display: none;">
        <strong>üì± –î–ª—è iPhone:</strong> 
        <p>1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Face ID / Touch ID –≤–∫–ª—é—á–µ–Ω –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö iPhone</p>
        <p>2. –í Telegram –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –±–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ</p>
        <p>3. –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –Ω–∞–∂–º–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å"</p>
    </div>

    <!-- –†–∞–∑–¥–µ–ª 2: –ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div class="auth-section">
        <div class="biometric-icon" id="biometric-icon">üëÜ</div>
        <h2 id="biometric-title">–ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥</h2>
        
        <button id="register-btn" class="secondary" disabled>
            üì± –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Face ID / Touch ID
        </button>
        
        <button id="login-btn" disabled>
            üîì –í–æ–π—Ç–∏ –ø–æ –±–∏–æ–º–µ—Ç—Ä–∏–∏
        </button>
        
        <p id="webauthn-status" class="status"></p>
    </div>

    <!-- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π PIN-–∫–æ–¥ –¥–ª—è iOS -->
    <div class="pin-section" id="pin-section" style="display: none;">
        <h2>üî¢ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤—Ö–æ–¥</h2>
        <p>–ï—Å–ª–∏ –±–∏–æ–º–µ—Ç—Ä–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ PIN-–∫–æ–¥</p>
        <input type="password" class="pin-input" id="pin-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric">
        <button id="pin-login-btn" class="secondary">–í–æ–π—Ç–∏ –ø–æ PIN-–∫–æ–¥—É</button>
    </div>
    
    <div class="info-note" id="browser-info"></div>
</div>

<script>
    // =================================================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // =================================================================
    const tg = window.Telegram.WebApp;
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const userDataEl = document.getElementById('user-data');
    const registerBtn = document.getElementById('register-btn');
    const loginBtn = document.getElementById('login-btn');
    const pinLoginBtn = document.getElementById('pin-login-btn');
    const webauthnStatusEl = document.getElementById('webauthn-status');
    const browserInfoEl = document.getElementById('browser-info');
    const iosInfoEl = document.getElementById('ios-info');
    const pinSectionEl = document.getElementById('pin-section');
    const pinInputEl = document.getElementById('pin-input');
    const biometricIconEl = document.getElementById('biometric-icon');
    const biometricTitleEl = document.getElementById('biometric-title');
    
    let telegramUser = null;
    let isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    let isInTelegram = tg.initDataUnsafe ? true : false;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º iOS –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (isIOS) {
        iosInfoEl.style.display = 'block';
        pinSectionEl.style.display = 'block';
        biometricIconEl.textContent = 'üì±';
        biometricTitleEl.textContent = 'Face ID / Touch ID';
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Telegram
    tg.ready();
    tg.expand();

    // =================================================================
    // –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
    // =================================================================
    
    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
        telegramUser = tg.initDataUnsafe.user;
        userDataEl.innerHTML = `
            –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <strong>${telegramUser.first_name || ''} ${telegramUser.last_name || ''}</strong>!
            <br>ID: <strong>${telegramUser.id}</strong>
        `;
        
        registerBtn.disabled = false;
        loginBtn.disabled = false;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –±–∏–æ–º–µ—Ç—Ä–∏—è
        const hasBiometric = localStorage.getItem(`webauthn_cred_${telegramUser.id}`);
        if (hasBiometric) {
            biometricIconEl.textContent = '‚úÖ';
        }

    } else {
        userDataEl.textContent = '‚ùå –û—à–∏–±–∫–∞: –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞';
        registerBtn.disabled = true;
        loginBtn.disabled = true;
    }

    // =================================================================
    // –ü–†–û–í–ï–†–ö–ê –ü–û–î–î–ï–†–ñ–ö–ò WEB AUTHN
    // =================================================================

    async function checkWebAuthnSupport() {
        let supportInfo = [];
        
        if (!window.PublicKeyCredential) {
            browserInfoEl.innerHTML = '‚ùå WebAuthn –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
            return false;
        }
        
        supportInfo.push('‚úÖ WebAuthn API –¥–æ—Å—Ç—É–ø–µ–Ω');
        
        try {
            const isAvailable = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
            if (isAvailable) {
                supportInfo.push('‚úÖ –ë–∏–æ–º–µ—Ç—Ä–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞');
                browserInfoEl.innerHTML = supportInfo.join('<br>');
                return true;
            } else {
                if (isIOS) {
                    supportInfo.push('üì± –ù–∞ iOS –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–æ–º–µ—Ç—Ä–∏—é');
                    browserInfoEl.innerHTML = supportInfo.join('<br>');
                    return true; // –ü—Ä–æ–±—É–µ–º –Ω–∞ iOS –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ—à–ª–∞
                }
                supportInfo.push('‚ùå –ë–∏–æ–º–µ—Ç—Ä–∏—è –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞');
                browserInfoEl.innerHTML = supportInfo.join('<br>');
                return false;
            }
        } catch (error) {
            console.log('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:', error);
            if (isIOS) {
                browserInfoEl.innerHTML = 'üì± –ù–∞ iOS –±–∏–æ–º–µ—Ç—Ä–∏—è –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å';
                return true;
            }
            return false;
        }
    }

    // =================================================================
    // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
    // =================================================================

    function generateChallenge() {
        const challenge = new Uint8Array(32);
        window.crypto.getRandomValues(challenge);
        return challenge;
    }

    function bufferToBase64(buffer) {
        return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)));
    }

    function base64ToBuffer(base64) {
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        return bytes;
    }

    // =================================================================
    // –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ë–ò–û–ú–ï–¢–†–ò–ò (–£–ü–†–û–©–ï–ù–ù–ê–Ø –î–õ–Ø iOS)
    // =================================================================

    registerBtn.addEventListener('click', async () => {
        if (!telegramUser) return;

        // –î–ª—è iOS —Å–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
        if (isIOS) {
            webauthnStatusEl.textContent = 'üì± –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Face ID...';
            webauthnStatusEl.className = 'status info';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ —á–µ—Ä–µ–∑ Telegram
            tg.showPopup({
                title: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Face ID',
                message: '–°–µ–π—á–∞—Å –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Face ID. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø.',
                buttons: [{type: 'ok'}]
            });
        }

        try {
            const challenge = generateChallenge();
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π userId
            const userId = new Uint8Array(16);
            const encoder = new TextEncoder();
            const idBytes = encoder.encode(String(telegramUser.id));
            userId.set(idBytes.slice(0, 16));

            // –ë–∞–∑–æ–≤—ã–µ –æ–ø—Ü–∏–∏
            const createOptions = {
                publicKey: {
                    challenge: challenge,
                    rp: {
                        name: "–£–º–Ω—ã–µ –ó–∞–º–µ—Ç–∫–∏",
                        id: window.location.hostname || "localhost"
                    },
                    user: {
                        id: userId,
                        name: String(telegramUser.id),
                        displayName: telegramUser.first_name || 'User',
                    },
                    pubKeyCredParams: [
                        { type: "public-key", alg: -7 }, // ES256
                        { type: "public-key", alg: -257 } // RS256
                    ],
                    authenticatorSelection: {
                        residentKey: "preferred",
                        userVerification: "preferred",
                    },
                    timeout: 60000,
                    attestation: "none",
                }
            };

            // –î–ª—è iOS –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
            if (isIOS) {
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            webauthnStatusEl.textContent = 'üîê –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Face ID / Touch ID –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...';
            
            const credential = await navigator.credentials.create(createOptions);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const credData = {
                id: credential.id,
                rawId: bufferToBase64(credential.rawId),
                type: credential.type
            };
            
            localStorage.setItem(`webauthn_cred_${telegramUser.id}`, JSON.stringify(credData));
            
            webauthnStatusEl.textContent = '‚úÖ –ë–∏–æ–º–µ—Ç—Ä–∏—è —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞!';
            webauthnStatusEl.className = 'status success';
            biometricIconEl.textContent = '‚úÖ';

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞:', err);
            
            let message = '–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∏–æ–º–µ—Ç—Ä–∏–∏';
            
            if (err.name === 'NotAllowedError') {
                if (isIOS) {
                    message = '‚ùå –î–æ—Å—Ç—É–ø –∫ Face ID –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö iPhone > Face ID > Telegram';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º popup –≤ Telegram
                    tg.showPopup({
                        title: '–û—à–∏–±–∫–∞ Face ID',
                        message: '–†–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Face ID –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö iPhone –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞',
                        buttons: [{type: 'ok'}]
                    });
                } else {
                    message = '‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º';
                }
            } else if (err.name === 'NotSupportedError') {
                message = '‚ùå –ë–∏–æ–º–µ—Ç—Ä–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ';
            } else {
                message = `‚ùå –û—à–∏–±–∫–∞: ${err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
            }
            
            webauthnStatusEl.textContent = message;
            webauthnStatusEl.className = 'status error';
        }
    });

    // =================================================================
    // –í–•–û–î –ü–û –ë–ò–û–ú–ï–¢–†–ò–ò
    // =================================================================

    loginBtn.addEventListener('click', async () => {
        if (!telegramUser) return;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        const storedCred = localStorage.getItem(`webauthn_cred_${telegramUser.id}`);
        
        if (!storedCred) {
            webauthnStatusEl.textContent = '‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –±–∏–æ–º–µ—Ç—Ä–∏—é';
            webauthnStatusEl.className = 'status error';
            return;
        }

        try {
            const challenge = generateChallenge();
            const credData = JSON.parse(storedCred);

            const getOptions = {
                publicKey: {
                    challenge: challenge,
                    timeout: 60000,
                    userVerification: "preferred",
                    rpId: window.location.hostname || "localhost",
                    allowCredentials: [{
                        type: "public-key",
                        id: base64ToBuffer(credData.rawId),
                        transports: ['internal']
                    }]
                }
            };

            webauthnStatusEl.textContent = 'üîê –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Face ID / Touch ID –¥–ª—è –≤—Ö–æ–¥–∞...';
            
            const assertion = await navigator.credentials.get(getOptions);
            
            webauthnStatusEl.textContent = '‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!';
            webauthnStatusEl.className = 'status success';
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Telegram
            tg.sendData(JSON.stringify({
                type: 'biometric_login',
                success: true,
                userId: telegramUser.id
            }));

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', err);
            
            let message = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
            if (err.name === 'NotAllowedError') {
                message = '‚ùå –í—Ö–æ–¥ –æ—Ç–º–µ–Ω–µ–Ω';
                // –í–∫–ª—é—á–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π PIN-–∫–æ–¥
                pinSectionEl.style.display = 'block';
            } else if (err.name === 'NotFoundError') {
                message = '‚ùå –ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
            } else {
                message = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
            }
            
            webauthnStatusEl.textContent = message;
            webauthnStatusEl.className = 'status error';
        }
    });

    // =================================================================
    // –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô –í–•–û–î –ü–û PIN-–ö–û–î–£ (–î–õ–Ø iOS)
    // =================================================================

    pinLoginBtn.addEventListener('click', () => {
        const pin = pinInputEl.value;
        
        if (pin.length === 4 && /^\d+$/.test(pin)) {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –ø—Ä–æ–≤–µ—Ä–∫–∞ PIN-–∫–æ–¥–∞
            webauthnStatusEl.textContent = '‚úÖ –í—Ö–æ–¥ –ø–æ PIN-–∫–æ–¥—É –≤—ã–ø–æ–ª–Ω–µ–Ω';
            webauthnStatusEl.className = 'status success';
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Telegram
            tg.sendData(JSON.stringify({
                type: 'pin_login',
                success: true,
                userId: telegramUser.id
            }));
            
            pinInputEl.value = '';
        } else {
            webauthnStatusEl.text = '‚ùå –í–≤–µ–¥–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π PIN-–∫–æ–¥';
            webauthnStatusEl.className = 'status error';
        }
    });

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ PIN-–∫–æ–¥–∞
    pinInputEl.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 4);
    });

    // =================================================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // =================================================================

    checkWebAuthnSupport().then(supported => {
        if (!supported && !isIOS) {
            registerBtn.disabled = true;
            loginBtn.disabled = true;
            pinSectionEl.style.display = 'block';
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    tg.onEvent('viewportChanged', () => {
        console.log('Viewport changed');
    });

    // –ì–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ Telegram (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    tg.MainButton.setText('–ó–∞–∫—Ä—ã—Ç—å');
    tg.MainButton.onClick(() => {
        tg.close();
    });

</script>

</body>
</html>
