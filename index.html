<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–£–º–Ω—ã–µ –ó–∞–º–µ—Ç–∫–∏ - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--tg-theme-bg-color, #f0f2f5);
            color: var(--tg-theme-text-color, #1c1e21);
            margin: 0;
            padding: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 20px;
            color: var(--tg-theme-text-color, #1c1e21);
            text-align: center;
        }
        
        h2 {
            font-size: 18px;
            margin: 16px 0;
            color: var(--tg-theme-hint-color, #2c3e50);
        }
        
        .user-card {
            background: var(--tg-theme-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--tg-theme-hint-color, #dee2e6);
        }
        
        .user-info {
            font-size: 16px;
            text-align: center;
        }
        
        .user-info strong {
            color: var(--tg-theme-button-color, #007bff);
        }
        
        .method-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .method-btn {
            flex: 1;
            min-width: 120px;
            background: var(--tg-theme-bg-color, #f8f9fa);
            border: 2px solid var(--tg-theme-hint-color, #dee2e6);
            color: var(--tg-theme-text-color, #1c1e21);
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .method-btn.active {
            border-color: var(--tg-theme-button-color, #007bff);
            background: var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        
        .method-btn:active {
            transform: scale(0.98);
        }
        
        .auth-section {
            margin: 20px 0;
            padding: 20px;
            background: var(--tg-theme-bg-color, #f8f9fa);
            border-radius: 12px;
            border: 1px solid var(--tg-theme-hint-color, #dee2e6);
        }
        
        button {
            background: var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 8px 0;
            transition: all 0.2s;
            -webkit-appearance: none;
            touch-action: manipulation;
        }
        
        button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        button:disabled {
            opacity: 0.5;
            transform: none;
            cursor: not-allowed;
        }
        
        button.secondary {
            background: transparent;
            border: 2px solid var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-color, #007bff);
        }
        
        .input-group {
            margin: 16px 0;
        }
        
        .pin-input {
            width: 100%;
            padding: 16px;
            font-size: 24px;
            text-align: center;
            letter-spacing: 8px;
            border: 2px solid var(--tg-theme-hint-color, #dee2e6);
            border-radius: 12px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #1c1e21);
            font-weight: 600;
        }
        
        .pin-input:focus {
            border-color: var(--tg-theme-button-color, #007bff);
            outline: none;
        }
        
        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .key {
            background: var(--tg-theme-bg-color, #f8f9fa);
            border: 2px solid var(--tg-theme-hint-color, #dee2e6);
            color: var(--tg-theme-text-color, #1c1e21);
            padding: 20px;
            font-size: 24px;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .key:active {
            background: var(--tg-theme-button-color, #007bff);
            color: white;
            transform: scale(0.95);
        }
        
        .status {
            margin-top: 16px;
            padding: 14px;
            border-radius: 10px;
            font-size: 14px;
            text-align: center;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .telegram-hint {
            background: rgba(0, 123, 255, 0.1);
            border-left: 4px solid var(--tg-theme-button-color, #007bff);
            padding: 16px;
            margin: 20px 0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .icon-large {
            font-size: 48px;
            text-align: center;
            margin: 10px 0;
        }
        
        .hidden {
            display: none !important;
        }
        
        .method-description {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #6c757d);
            margin-top: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üîê –£–º–Ω—ã–µ –ó–∞–º–µ—Ç–∫–∏</h1>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
    <div class="user-card">
        <div class="user-info" id="userData">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    
    <!-- –í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
    <div class="method-selector">
        <button class="method-btn active" data-method="pin">üî¢ PIN-–∫–æ–¥</button>
        <button class="method-btn" data-method="telegram">üì± Telegram</button>
        <button class="method-btn" data-method="biometric">üëÜ Face ID</button>
    </div>
    
    <!-- PIN-–∫–æ–¥ –º–µ—Ç–æ–¥ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–∫—Ç–∏–≤–µ–Ω) -->
    <div id="pinMethod" class="auth-section">
        <div class="icon-large">üî¢</div>
        <h2>–í—Ö–æ–¥ –ø–æ PIN-–∫–æ–¥—É</h2>
        <p class="method-description">–í–≤–µ–¥–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π PIN-–∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞</p>
        
        <!-- –ü–æ–ª–µ –¥–ª—è PIN -->
        <div class="input-group">
            <input type="password" 
                   class="pin-input" 
                   id="pinInput" 
                   maxlength="4" 
                   inputmode="numeric" 
                   pattern="[0-9]*"
                   placeholder="‚óè‚óè‚óè‚óè"
                   autocomplete="off">
        </div>
        
        <!-- –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ -->
        <div class="pin-keypad" id="pinKeypad">
            <div class="key" data-number="1">1</div>
            <div class="key" data-number="2">2</div>
            <div class="key" data-number="3">3</div>
            <div class="key" data-number="4">4</div>
            <div class="key" data-number="5">5</div>
            <div class="key" data-number="6">6</div>
            <div class="key" data-number="7">7</div>
            <div class="key" data-number="8">8</div>
            <div class="key" data-number="9">9</div>
            <div class="key" data-number="clear" style="font-size: 18px;">‚å´</div>
            <div class="key" data-number="0">0</div>
            <div class="key" data-number="ok" style="background: #007bff; color: white;">‚úì</div>
        </div>
        
        <button id="setPinBtn" class="secondary">üìù –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PIN-–∫–æ–¥</button>
        <button id="loginWithPinBtn">üîì –í–æ–π—Ç–∏ –ø–æ PIN-–∫–æ–¥—É</button>
    </div>
    
    <!-- Telegram –º–µ—Ç–æ–¥ -->
    <div id="telegramMethod" class="auth-section hidden">
        <div class="icon-large">üì±</div>
        <h2>–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram</h2>
        <p class="method-description">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ Telegram</p>
        
        <div class="telegram-hint">
            <strong>‚úì –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥</strong><br>
            –í—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ Telegram. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
        </div>
        
        <button id="telegramLoginBtn">üîì –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</button>
    </div>
    
    <!-- –ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥ (—Å –∑–∞–ø–∞—Å–Ω—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º) -->
    <div id="biometricMethod" class="auth-section hidden">
        <div class="icon-large" id="biometricIcon">üëÜ</div>
        <h2 id="biometricTitle">Face ID / Touch ID</h2>
        <p class="method-description" id="biometricDescription">
            –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∏–æ–º–µ—Ç—Ä–∏—é –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—Ö–æ–¥–∞
        </p>
        
        <div id="biometricUnavailable" class="telegram-hint" style="display: none;">
            <strong>‚ö†Ô∏è Face ID –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</strong><br>
            –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ Telegram –¥–ª—è iOS –±–∏–æ–º–µ—Ç—Ä–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. 
            –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ PIN-–∫–æ–¥ –∏–ª–∏ –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram.
        </div>
        
        <button id="checkBiometricBtn" class="secondary">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å</button>
        <button id="biometricLoginBtn" disabled>üîì –í–æ–π—Ç–∏ –ø–æ –±–∏–æ–º–µ—Ç—Ä–∏–∏</button>
        <button id="biometricSetupBtn" disabled>üì± –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –±–∏–æ–º–µ—Ç—Ä–∏—é</button>
    </div>
    
    <!-- –°—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="statusMessage" class="status"></div>
</div>

<script>
    // =================================================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // =================================================================
    
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    const state = {
        user: null,
        isIOS: /iPhone|iPad|iPod/i.test(navigator.userAgent),
        isAndroid: /Android/i.test(navigator.userAgent),
        isTelegram: Boolean(tg.initDataUnsafe),
        currentMethod: 'pin',
        biometricAvailable: false,
        pin: localStorage.getItem('user_pin') || null
    };
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const elements = {
        userData: document.getElementById('userData'),
        methodBtns: document.querySelectorAll('.method-btn'),
        pinMethod: document.getElementById('pinMethod'),
        telegramMethod: document.getElementById('telegramMethod'),
        biometricMethod: document.getElementById('biometricMethod'),
        pinInput: document.getElementById('pinInput'),
        setPinBtn: document.getElementById('setPinBtn'),
        loginWithPinBtn: document.getElementById('loginWithPinBtn'),
        telegramLoginBtn: document.getElementById('telegramLoginBtn'),
        checkBiometricBtn: document.getElementById('checkBiometricBtn'),
        biometricLoginBtn: document.getElementById('biometricLoginBtn'),
        biometricSetupBtn: document.getElementById('biometricSetupBtn'),
        biometricUnavailable: document.getElementById('biometricUnavailable'),
        biometricIcon: document.getElementById('biometricIcon'),
        biometricTitle: document.getElementById('biometricTitle'),
        biometricDescription: document.getElementById('biometricDescription'),
        statusMessage: document.getElementById('statusMessage')
    };
    
    // =================================================================
    // –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
    // =================================================================
    
    if (state.isTelegram && tg.initDataUnsafe.user) {
        state.user = tg.initDataUnsafe.user;
        elements.userData.innerHTML = `
            <strong>${state.user.first_name || ''} ${state.user.last_name || ''}</strong><br>
            ID: ${state.user.id}<br>
            <small>${state.isIOS ? 'üì± iOS' : 'üì± Android'}</small>
        `;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π PIN –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const savedPin = localStorage.getItem(`pin_${state.user.id}`);
        if (savedPin) {
            state.pin = savedPin;
        }
    } else {
        elements.userData.innerHTML = '‚ùå –û—à–∏–±–∫–∞: –æ—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram';
        showStatus('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ –≤ Telegram', 'error');
    }
    
    // =================================================================
    // –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ú–ï–¢–û–î–û–í –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò
    // =================================================================
    
    elements.methodBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const method = btn.dataset.method;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            elements.methodBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥
            elements.pinMethod.classList.add('hidden');
            elements.telegramMethod.classList.add('hidden');
            elements.biometricMethod.classList.add('hidden');
            
            if (method === 'pin') {
                elements.pinMethod.classList.remove('hidden');
            } else if (method === 'telegram') {
                elements.telegramMethod.classList.remove('hidden');
            } else if (method === 'biometric') {
                elements.biometricMethod.classList.remove('hidden');
                checkBiometricSupport();
            }
            
            state.currentMethod = method;
        });
    });
    
    // =================================================================
    // –ú–ï–¢–û–î 1: PIN-–ö–û–î
    // =================================================================
    
    // –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
    document.querySelectorAll('.key[data-number]').forEach(key => {
        key.addEventListener('click', () => {
            const number = key.dataset.number;
            
            if (number === 'clear') {
                // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–º–≤–æ–ª
                elements.pinInput.value = elements.pinInput.value.slice(0, -1);
            } else if (number === 'ok') {
                // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –≤–≤–æ–¥
                if (elements.pinInput.value.length === 4) {
                    loginWithPin(elements.pinInput.value);
                }
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º —Ü–∏—Ñ—Ä—É
                if (elements.pinInput.value.length < 4) {
                    elements.pinInput.value += number;
                }
            }
        });
    });
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PIN-–∫–æ–¥–∞
    elements.setPinBtn.addEventListener('click', () => {
        const pin = elements.pinInput.value;
        
        if (pin.length !== 4 || !/^\d+$/.test(pin)) {
            showStatus('–í–≤–µ–¥–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π PIN-–∫–æ–¥', 'error');
            return;
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º PIN –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        localStorage.setItem(`pin_${state.user.id}`, pin);
        state.pin = pin;
        
        showStatus('‚úÖ PIN-–∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
        elements.pinInput.value = '';
    });
    
    // –í—Ö–æ–¥ –ø–æ PIN-–∫–æ–¥—É
    elements.loginWithPinBtn.addEventListener('click', () => {
        const pin = elements.pinInput.value;
        loginWithPin(pin);
    });
    
    function loginWithPin(pin) {
        const savedPin = localStorage.getItem(`pin_${state.user.id}`);
        
        if (!savedPin) {
            showStatus('‚ùå PIN-–∫–æ–¥ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ PIN.', 'error');
            return;
        }
        
        if (pin === savedPin) {
            showStatus('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Telegram
            tg.sendData(JSON.stringify({
                method: 'pin',
                success: true,
                userId: state.user.id
            }));
            
            elements.pinInput.value = '';
        } else {
            showStatus('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π PIN-–∫–æ–¥', 'error');
            elements.pinInput.value = '';
        }
    }
    
    // =================================================================
    // –ú–ï–¢–û–î 2: TELEGRAM
    // =================================================================
    
    elements.telegramLoginBtn.addEventListener('click', () => {
        // –ü—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ Telegram
        showStatus('‚úÖ –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
        
        tg.sendData(JSON.stringify({
            method: 'telegram',
            success: true,
            userId: state.user.id,
            userData: state.user
        }));
    });
    
    // =================================================================
    // –ú–ï–¢–û–î 3: –ë–ò–û–ú–ï–¢–†–ò–Ø (–° –ó–ê–ü–ê–°–ù–´–ú –í–ê–†–ò–ê–ù–¢–û–ú)
    // =================================================================
    
    async function checkBiometricSupport() {
        elements.biometricUnavailable.style.display = 'none';
        
        // –ù–∞ iOS –≤ Telegram WebView –±–∏–æ–º–µ—Ç—Ä–∏—è –ù–ï –†–ê–ë–û–¢–ê–ï–¢
        if (state.isIOS) {
            elements.biometricUnavailable.style.display = 'block';
            elements.biometricIcon.textContent = '‚ùå';
            elements.biometricTitle.textContent = 'Face ID –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω';
            elements.biometricDescription.textContent = 
                'Telegram –¥–ª—è iOS –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Face ID –≤ WebApp. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ PIN-–∫–æ–¥.';
            elements.biometricLoginBtn.disabled = true;
            elements.biometricSetupBtn.disabled = true;
            state.biometricAvailable = false;
            return;
        }
        
        // –ù–∞ Android –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
        if (window.PublicKeyCredential) {
            try {
                const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                
                if (available) {
                    elements.biometricIcon.textContent = '‚úÖ';
                    elements.biometricTitle.textContent = '–ë–∏–æ–º–µ—Ç—Ä–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞';
                    elements.biometricDescription.textContent = 
                        '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–ø–µ—á–∞—Ç–æ–∫ –ø–∞–ª—å—Ü–∞ –∏–ª–∏ —Å–∫–∞–Ω–µ—Ä –ª–∏—Ü–∞';
                    elements.biometricLoginBtn.disabled = false;
                    elements.biometricSetupBtn.disabled = false;
                    state.biometricAvailable = true;
                } else {
                    showBiometricUnavailable();
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∏–æ–º–µ—Ç—Ä–∏–∏:', e);
                showBiometricUnavailable();
            }
        } else {
            showBiometricUnavailable();
        }
    }
    
    function showBiometricUnavailable() {
        elements.biometricUnavailable.style.display = 'block';
        elements.biometricIcon.textContent = '‚ùå';
        elements.biometricTitle.textContent = '–ë–∏–æ–º–µ—Ç—Ä–∏—è –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞';
        elements.biometricLoginBtn.disabled = true;
        elements.biometricSetupBtn.disabled = true;
        state.biometricAvailable = false;
    }
    
    elements.checkBiometricBtn.addEventListener('click', checkBiometricSupport);
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∏–æ–º–µ—Ç—Ä–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è Android)
    elements.biometricSetupBtn.addEventListener('click', async () => {
        if (!state.biometricAvailable) {
            showStatus('–ë–∏–æ–º–µ—Ç—Ä–∏—è –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ', 'error');
            return;
        }
        
        showStatus('üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∏–æ–º–µ—Ç—Ä–∏–∏...', 'info');
        
        try {
            // –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –±–∏–æ–º–µ—Ç—Ä–∏–∏
            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);
            
            const createOptions = {
                publicKey: {
                    challenge: challenge,
                    rp: { name: "–£–º–Ω—ã–µ –ó–∞–º–µ—Ç–∫–∏", id: window.location.hostname },
                    user: {
                        id: new TextEncoder().encode(String(state.user.id)),
                        name: String(state.user.id),
                        displayName: state.user.first_name || 'User'
                    },
                    pubKeyCredParams: [{ type: "public-key", alg: -7 }],
                    authenticatorSelection: { userVerification: "required" },
                    timeout: 60000,
                    attestation: "none"
                }
            };
            
            const credential = await navigator.credentials.create(createOptions);
            
            if (credential) {
                localStorage.setItem(`biometric_${state.user.id}`, 'enabled');
                showStatus('‚úÖ –ë–∏–æ–º–µ—Ç—Ä–∏—è —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞!', 'success');
            }
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∏–æ–º–µ—Ç—Ä–∏–∏:', err);
            showStatus(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`, 'error');
        }
    });
    
    // –í—Ö–æ–¥ –ø–æ –±–∏–æ–º–µ—Ç—Ä–∏–∏
    elements.biometricLoginBtn.addEventListener('click', async () => {
        if (!state.biometricAvailable) {
            showStatus('–ë–∏–æ–º–µ—Ç—Ä–∏—è –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
            return;
        }
        
        const hasBiometric = localStorage.getItem(`biometric_${state.user.id}`);
        if (!hasBiometric) {
            showStatus('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –±–∏–æ–º–µ—Ç—Ä–∏—é', 'error');
            return;
        }
        
        showStatus('üîê –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∏–æ–º–µ—Ç—Ä–∏—é –¥–ª—è –≤—Ö–æ–¥–∞...', 'info');
        
        try {
            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);
            
            const getOptions = {
                publicKey: {
                    challenge: challenge,
                    timeout: 60000,
                    userVerification: "required",
                    rpId: window.location.hostname
                }
            };
            
            const assertion = await navigator.credentials.get(getOptions);
            
            if (assertion) {
                showStatus('‚úÖ –í—Ö–æ–¥ –ø–æ –±–∏–æ–º–µ—Ç—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω!', 'success');
                
                tg.sendData(JSON.stringify({
                    method: 'biometric',
                    success: true,
                    userId: state.user.id
                }));
            }
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –ø–æ –±–∏–æ–º–µ—Ç—Ä–∏–∏:', err);
            showStatus(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`, 'error');
        }
    });
    
    // =================================================================
    // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
    // =================================================================
    
    function showStatus(message, type = 'info') {
        elements.statusMessage.textContent = message;
        elements.statusMessage.className = `status ${type}`;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è iOS
    if (state.isIOS) {
        const hint = document.createElement('div');
        hint.className = 'telegram-hint';
        hint.innerHTML = `
            <strong>üì± –î–ª—è iOS:</strong><br>
            Face ID –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Telegram WebView. 
            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ PIN-–∫–æ–¥ –∏–ª–∏ –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram.
        `;
        document.querySelector('.container').appendChild(hint);
    }
    
    // =================================================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // =================================================================
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    showStatus('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞', 'info');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∏–æ–º–µ—Ç—Ä–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    checkBiometricSupport();

</script>

</body>
</html>
