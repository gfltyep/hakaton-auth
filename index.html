<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–£–º–Ω—ã–µ –ó–∞–º–µ—Ç–∫–∏ - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            margin: 0;
            padding: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
        }
        .container {
            background: #fff;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #1c1e21;
        }
        h2 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #2c3e50;
        }
        .user-card {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .user-info {
            font-size: 16px;
        }
        .user-info strong {
            color: #007bff;
        }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            -webkit-appearance: none;
            appearance: none;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
        }
        button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        button:disabled {
            background-color: #cccccc;
            transform: none;
            opacity: 0.7;
            cursor: not-allowed;
        }
        button.primary {
            background-color: #007bff;
        }
        button.secondary {
            background-color: #34c759;
        }
        button.warning {
            background-color: #ff9500;
        }
        .status {
            margin-top: 16px;
            padding: 14px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 15px;
            transition: all 0.3s;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .debug-section {
            margin-top: 20px;
            padding: 16px;
            background-color: #f8f9fa;
            border-radius: 12px;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #dee2e6;
        }
        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #495057;
        }
        .debug-content {
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
            background-color: #fff;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ced4da;
        }
        .debug-entry {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #e9ecef;
        }
        .debug-entry:last-child {
            border-bottom: none;
        }
        .timestamp {
            color: #6c757d;
            font-size: 10px;
        }
        .biometric-icon {
            font-size: 48px;
            margin: 10px 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .test-badge {
            background-color: #ffc107;
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }
        .device-info {
            font-size: 13px;
            color: #6c757d;
            margin: 10px 0;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 8px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üîê –£–º–Ω—ã–µ –ó–∞–º–µ—Ç–∫–∏</h1>
    
    <div class="device-info" id="deviceInfo">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...</div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
    <div class="user-card">
        <div class="user-info" id="user-data">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>

    <!-- –ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è -->
    <div class="biometric-icon" id="biometricIcon">üì±</div>
    <h2 id="biometricTitle">–ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h2>
    
    <div class="button-group">
        <button id="diagnosticBtn" class="warning">üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ WebAuthn</button>
        <button id="registerBtn" class="secondary" disabled>üì± –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Face ID</button>
        <button id="loginBtn" class="primary" disabled>üîì –í–æ–π—Ç–∏ –ø–æ Face ID</button>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å -->
    <div id="statusMessage" class="status"></div>

    <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è —Å–µ–∫—Ü–∏—è (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞) -->
    <div class="debug-section" id="debugSection" style="display: none;">
        <div class="debug-header">
            <span>üìã –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
            <button id="toggleDebug" style="width: auto; padding: 4px 8px; background-color: #6c757d;">–°–∫—Ä—ã—Ç—å</button>
        </div>
        <div class="debug-content" id="debugContent"></div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞ –æ—Ç–ª–∞–¥–∫–∏ -->
    <button id="showDebugBtn" style="background-color: #6c757d; margin-top: 10px; padding: 8px;">üìã –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–∫—É</button>
</div>

<script>
    // =================================================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –ù–ê–°–¢–†–û–ô–ö–ê
    // =================================================================
    
    const tg = window.Telegram.WebApp;
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const elements = {
        userData: document.getElementById('user-data'),
        registerBtn: document.getElementById('registerBtn'),
        loginBtn: document.getElementById('loginBtn'),
        diagnosticBtn: document.getElementById('diagnosticBtn'),
        statusMessage: document.getElementById('statusMessage'),
        debugSection: document.getElementById('debugSection'),
        debugContent: document.getElementById('debugContent'),
        showDebugBtn: document.getElementById('showDebugBtn'),
        deviceInfo: document.getElementById('deviceInfo'),
        biometricIcon: document.getElementById('biometricIcon'),
        biometricTitle: document.getElementById('biometricTitle')
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    const state = {
        telegramUser: null,
        isIOS: /iPhone|iPad|iPod/i.test(navigator.userAgent),
        isInTelegram: Boolean(tg.initDataUnsafe),
        debugLogs: [],
        diagnosticResults: {}
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
    tg.ready();
    tg.expand();

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
    updateDeviceInfo();

    // =================================================================
    // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
    // =================================================================

    function addDebugLog(category, message, data = null) {
        const logEntry = {
            timestamp: new Date().toISOString(),
            category,
            message,
            data: data ? JSON.stringify(data) : null
        };
        state.debugLogs.push(logEntry);
        updateDebugDisplay();
        console.log(`[${category}] ${message}`, data || '');
    }

    function updateDebugDisplay() {
        if (!elements.debugContent) return;
        
        const html = state.debugLogs.slice(-10).reverse().map(log => `
            <div class="debug-entry">
                <span class="timestamp">${new Date(log.timestamp).toLocaleTimeString()}</span>
                <strong>${log.category}:</strong> ${log.message}
                ${log.data ? `<br><small>${log.data}</small>` : ''}
            </div>
        `).join('');
        
        elements.debugContent.innerHTML = html || '<div class="debug-entry">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';
    }

    function setStatus(message, type = 'info') {
        elements.statusMessage.textContent = message;
        elements.statusMessage.className = `status ${type}`;
        addDebugLog('STATUS', message, { type });
    }

    function updateDeviceInfo() {
        const info = [
            `–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${state.isIOS ? 'üì± iPhone/iPad' : 'üì± –î—Ä—É–≥–æ–µ'}`,
            `Telegram WebApp: ${state.isInTelegram ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}`,
            `User Agent: ${navigator.userAgent.substring(0, 50)}...`
        ].join('<br>');
        elements.deviceInfo.innerHTML = info;
    }

    // =================================================================
    // –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
    // =================================================================

    if (state.isInTelegram && tg.initDataUnsafe.user) {
        state.telegramUser = tg.initDataUnsafe.user;
        elements.userData.innerHTML = `
            <strong>${state.telegramUser.first_name || ''} ${state.telegramUser.last_name || ''}</strong>
            <br>ID: ${state.telegramUser.id}
        `;
        
        elements.registerBtn.disabled = false;
        elements.loginBtn.disabled = false;
        
        addDebugLog('USER', '–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª—É—á–µ–Ω—ã', state.telegramUser);
    } else {
        elements.userData.innerHTML = '‚ùå –û—à–∏–±–∫–∞: –æ—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram';
        setStatus('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ –≤ Telegram', 'error');
        addDebugLog('ERROR', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    }

    // =================================================================
    // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê WEB AUTHN
    // =================================================================

    async function runDiagnostics() {
        setStatus('üîç –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞...', 'info');
        elements.diagnosticBtn.disabled = true;
        
        const results = {
            webAuthnSupported: false,
            platformAuthenticator: false,
            userVerifyingPlatformAuthenticator: false,
            conditionalMediation: false,
            errors: []
        };

        try {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WebAuthn
            results.webAuthnSupported = 'PublicKeyCredential' in window;
            addDebugLog('DIAG', 'WebAuthn –ø–æ–¥–¥–µ—Ä–∂–∫–∞', { supported: results.webAuthnSupported });

            if (results.webAuthnSupported) {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: Platform authenticator
                try {
                    results.platformAuthenticator = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                    addDebugLog('DIAG', 'Platform authenticator', { available: results.platformAuthenticator });
                } catch (e) {
                    results.errors.push('platform_check: ' + e.message);
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: Conditional mediation
                if (PublicKeyCredential.isConditionalMediationAvailable) {
                    try {
                        results.conditionalMediation = await PublicKeyCredential.isConditionalMediationAvailable();
                        addDebugLog('DIAG', 'Conditional mediation', { available: results.conditionalMediation });
                    } catch (e) {
                        results.errors.push('conditional_check: ' + e.message);
                    }
                }
            }
        } catch (e) {
            results.errors.push('general: ' + e.message);
            addDebugLog('ERROR', '–û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏', e.message);
        }

        state.diagnosticResults = results;
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
        let message = 'üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:\n';
        message += `‚Ä¢ WebAuthn: ${results.webAuthnSupported ? '‚úÖ' : '‚ùå'}\n`;
        message += `‚Ä¢ Platform Auth: ${results.platformAuthenticator ? '‚úÖ' : '‚ùå'}\n`;
        if (results.errors.length > 0) {
            message += `‚Ä¢ –û—à–∏–±–∫–∏: ${results.errors.length}`;
        }
        
        setStatus(message, results.platformAuthenticator ? 'success' : 'warning');
        elements.diagnosticBtn.disabled = false;
        
        return results;
    }

    // =================================================================
    // –£–ü–†–û–©–ï–ù–ù–ê–Ø –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –° –û–î–ù–ò–ú –ö–ê–°–ê–ù–ò–ï–ú
    // =================================================================

    async function createBiometricCredential() {
        if (!state.telegramUser) return;

        try {
            // –î–ª—è iOS –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (state.isIOS) {
                setStatus('üì± –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –µ—â–µ —Ä–∞–∑ –¥–ª—è –≤—ã–∑–æ–≤–∞ Face ID...', 'info');
                
                // –ü—Ä–æ–±—É–µ–º –≤—ã–∑–≤–∞—Ç—å WebAuthn —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);

                // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ –¥–ª—è iOS
                const createOptions = {
                    publicKey: {
                        challenge: challenge,
                        rp: {
                            name: "–£–º–Ω—ã–µ –ó–∞–º–µ—Ç–∫–∏",
                            id: window.location.hostname || "localhost"
                        },
                        user: {
                            id: new TextEncoder().encode(String(state.telegramUser.id)),
                            name: String(state.telegramUser.id),
                            displayName: state.telegramUser.first_name || 'User'
                        },
                        pubKeyCredParams: [
                            { type: "public-key", alg: -7 }
                        ],
                        authenticatorSelection: {
                            userVerification: "required",
                            residentKey: "discouraged"
                        },
                        timeout: 60000,
                        attestation: "none"
                    }
                };

                addDebugLog('WEBAUTHN', '–ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', createOptions);

                // –í–∞–∂–Ω–æ: –Ω–∞ iOS –Ω—É–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∫–∞—Å–∞–Ω–∏—è
                const credential = await navigator.credentials.create(createOptions);
                
                if (credential) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ ID
                    localStorage.setItem(`webauthn_id_${state.telegramUser.id}`, credential.id);
                    setStatus('‚úÖ Face ID —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!', 'success');
                    elements.biometricIcon.textContent = '‚úÖ';
                    addDebugLog('SUCCESS', '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞', { id: credential.id });
                }
            } else {
                // –î–ª—è –¥—Ä—É–≥–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º
                setStatus('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∏–æ–º–µ—Ç—Ä–∏–∏...', 'info');
                // ... –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –∫–æ–¥
            }
        } catch (err) {
            handleWebAuthnError(err);
        }
    }

    function handleWebAuthnError(err) {
        addDebugLog('ERROR', 'WebAuthn –æ—à–∏–±–∫–∞', { name: err.name, message: err.message });
        
        let message = '–û—à–∏–±–∫–∞: ';
        switch (err.name) {
            case 'NotAllowedError':
                if (state.isIOS) {
                    message = '‚ùå Face ID –Ω–µ –≤—ã–∑–≤–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n' +
                             '1. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É –µ—â–µ —Ä–∞–∑\n' +
                             '2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Face ID\n' +
                             '3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Telegram';
                } else {
                    message = '‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º';
                }
                break;
            case 'NotSupportedError':
                message = '‚ùå –ë–∏–æ–º–µ—Ç—Ä–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                break;
            case 'SecurityError':
                message = '‚ùå –û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (—Ç—Ä–µ–±—É–µ—Ç—Å—è HTTPS)';
                break;
            default:
                message = `‚ùå ${err.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
        }
        
        setStatus(message, 'error');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º popup –≤ Telegram
        if (state.isInTelegram) {
            tg.showPopup({
                title: '–û—à–∏–±–∫–∞ Face ID',
                message: message,
                buttons: [{ type: 'ok' }]
            });
        }
    }

    // =================================================================
    // –¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú (–ï–°–õ–ò WEB AUTHN –ù–ï –†–ê–ë–û–¢–ê–ï–¢)
    // =================================================================

    function useTestMode() {
        setStatus('üß™ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º', 'warning');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        localStorage.setItem(`test_mode_${state.telegramUser.id}`, 'true');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        tg.showPopup({
            title: '–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º',
            message: 'Face ID –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º.',
            buttons: [{ type: 'ok' }]
        });
    }

    // =================================================================
    // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô
    // =================================================================

    // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
    elements.diagnosticBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await runDiagnostics();
    });

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    elements.registerBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        
        if (!state.telegramUser) return;
        
        elements.registerBtn.disabled = true;
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –ø–µ—Ä–µ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π
        const diag = await runDiagnostics();
        
        if (!diag.platformAuthenticator && !state.isIOS) {
            useTestMode();
            elements.registerBtn.disabled = false;
            return;
        }
        
        // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å –±–∏–æ–º–µ—Ç—Ä–∏—é
        await createBiometricCredential();
        
        elements.registerBtn.disabled = false;
    });

    // –í—Ö–æ–¥
    elements.loginBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        
        if (!state.telegramUser) return;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        const hasCredential = localStorage.getItem(`webauthn_id_${state.telegramUser.id}`);
        const testMode = localStorage.getItem(`test_mode_${state.telegramUser.id}`);
        
        if (testMode) {
            setStatus('‚úÖ –í—Ö–æ–¥ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ', 'success');
            return;
        }
        
        if (!hasCredential) {
            setStatus('‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –±–∏–æ–º–µ—Ç—Ä–∏—é', 'error');
            return;
        }
        
        setStatus('üîê –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Face ID –¥–ª—è –≤—Ö–æ–¥–∞...', 'info');
        
        try {
            // –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞
            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);
            
            const getOptions = {
                publicKey: {
                    challenge: challenge,
                    timeout: 60000,
                    userVerification: "required",
                    rpId: window.location.hostname || "localhost"
                }
            };
            
            const assertion = await navigator.credentials.get(getOptions);
            
            setStatus('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
            addDebugLog('SUCCESS', '–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Telegram
            tg.sendData(JSON.stringify({
                type: 'biometric_login',
                success: true,
                userId: state.telegramUser.id
            }));
            
        } catch (err) {
            handleWebAuthnError(err);
        }
    });

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–∫–æ–π
    elements.showDebugBtn.addEventListener('click', () => {
        elements.debugSection.style.display = 'block';
        elements.showDebugBtn.style.display = 'none';
    });

    document.getElementById('toggleDebug').addEventListener('click', () => {
        elements.debugSection.style.display = 'none';
        elements.showDebugBtn.style.display = 'block';
    });

    // =================================================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // =================================================================

    addDebugLog('INIT', '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ', {
        ios: state.isIOS,
        telegram: state.isInTelegram,
        timestamp: new Date().toISOString()
    });

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    setTimeout(() => {
        runDiagnostics();
    }, 1000);

</script>

</body>
</html>
